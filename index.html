<!-- QR Code Check-In Scanner -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Check-In Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .scanner-container { max-width: 500px; margin: auto; padding: 20px; }
        #reader { width: 100%; border-radius: 0.75rem; overflow: hidden; }
        .error-message { color: #e53e3e; font-weight: 600; padding: 10px; border: 1px solid #fed7d7; background-color: #fff5f5; border-radius: 0.5rem; margin-top: 10px; }
        .success-message { color: #2f855a; font-weight: 600; padding: 10px; border: 1px solid #c6f6d5; background-color: #f0fff4; border-radius: 0.5rem; margin-top: 10px; }
        .info-message { color: #2c5282; font-weight: 600; padding: 10px; border: 1px solid #bee3f8; background-color: #ebf8ff; border-radius: 0.5rem; margin-top: 10px; }
    </style>
</head>
<body>

<div class="scanner-container bg-white shadow-xl rounded-xl mt-8">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">Event Check-In V5</h1>
    <p class="text-sm text-center text-gray-500 mb-6">Scan QR code to check in participants.</p>

    <!-- Session Selection -->
    <div class="mb-6">
        <label for="session-select" class="block text-sm font-medium text-gray-700 mb-2">Current Session:</label>
        <select id="session-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out">
            <option value="Morning Session">Morning Session</option>
            <option value="Afternoon Session">Afternoon Session</option>
        </select>
    </div>

    <!-- QR Scanner Placeholder -->
    <div id="reader"></div>

    <!-- Status Display -->
    <div id="status-display" class="mt-4 p-4 rounded-lg text-center font-semibold transition duration-300 min-h-[50px] flex items-center justify-center bg-gray-100 text-gray-600">
        Scanner initializing...
    </div>

</div>

<!-- QR Code Library -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
    // ðŸš¨ IMPORTANT: REPLACE THIS PLACEHOLDER WITH YOUR **LATEST, DEPLOYED** GOOGLE APPS SCRIPT WEB APP URL
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxhWZWtIoJJRFdCM439zzjLXqjrfzk41C1ouWPZ2Wa0oXBHFtTyfDOHk0130Xv3X6lF/exec"; 

    let scanner;
    let scanTimeout;
    const POLLING_INTERVAL = 100; // ms
    const MAX_POLLING_TIME = 3000; // 3 seconds

    // --- UI/Status Functions ---

    function setStatus(message, type = 'info') {
        const display = document.getElementById('status-display');
        display.textContent = message;
        display.className = 'mt-4 p-4 rounded-lg text-center font-semibold transition duration-300 min-h-[50px] flex items-center justify-center';

        if (type === 'success') {
            display.classList.add('success-message');
            display.classList.remove('error-message', 'info-message');
        } else if (type === 'error') {
            display.classList.add('error-message');
            display.classList.remove('success-message', 'info-message');
        } else {
            display.classList.add('info-message');
            display.classList.remove('success-message', 'error-message');
        }
    }

    // --- Apps Script Communication ---

    async function sendDataToSheet(email, session) {
        setStatus(`Sending data for ${email}...`, 'info');
        
        try {
            const response = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                mode: 'cors', // Essential for cross-origin requests
                headers: {
                    'Content-Type': 'text/plain', // Use text/plain to avoid preflight issues with Apps Script
                },
                body: JSON.stringify({ email, session }),
            });

            // If fetch succeeds but the HTTP status is an error (e.g., 404, 500)
            if (!response.ok) {
                // Log the precise HTTP status failure
                const errorBody = await response.text();
                const errorMessage = `HTTP Error ${response.status}: ${response.statusText}. Response body: ${errorBody.substring(0, 100)}`;
                setStatus(`Fetch failed: HTTP Error! Check Console for details.`, 'error');
                console.error("Apps Script HTTP Response Failure:", errorMessage);
                throw new Error(`HTTP Status ${response.status}`);
            }

            const result = await response.json();

            // Process response from Google Apps Script
            let message, type;
            switch (result.status) {
                case 'success':
                    message = `âœ… Success! ${result.name || result.email} checked into ${result.session}.`;
                    type = 'success';
                    break;
                case 'wrong_session':
                    message = `âš ï¸ Session Mismatch! ${result.name} checked in to ${result.session}. Expected: ${result.expected}. Sheet row highlighted yellow.`;
                    type = 'info'; // Use info/warning color for expected mismatch
                    break;
                case 'already_checked':
                    message = `âŒ Already Checked In! ${result.name} at ${result.checkInTime}.`;
                    type = 'error';
                    break;
                case 'unverified':
                    message = `âŒ Unverified Email: ${result.email}. Not in the list.`;
                    type = 'error';
                    break;
                default:
                    message = `ðŸš¨ Unknown Server Error: ${result.message || 'Check Apps Script logs.'}`;
                    type = 'error';
            }
            setStatus(message, type);

        } catch (error) {
            // This block handles network failures (like "Load Failed") or JSON parsing errors
            setStatus(`Fetch error: Load Failed. Check Console!`, 'error');
            // Log the critical network error details
            console.error("CRITICAL NETWORK ERROR:", error);
            console.error("ACTION REQUIRED: Re-check your Apps Script Deployment permissions (set to 'Anyone') and ensure the GAS_WEB_APP_URL is correct and ends in /exec.");
        }
    }

    // --- QR Scanner Logic ---

    function onScanSuccess(decodedText, decodedResult) {
        if (scanTimeout) {
            clearTimeout(scanTimeout);
        }
        
        // Stop the scanner momentarily to prevent rapid rescan
        scanner.pause();

        const selectedSession = document.getElementById('session-select').value;
        
        // Send data to Google Sheet
        sendDataToSheet(decodedText, selectedSession);

        // Resume scanning after 5 seconds to give user time to move QR code
        scanTimeout = setTimeout(() => {
            scanner.resume();
            setStatus('Ready to scan next participant.', 'info');
        }, 5000); 
    }

    function onScanFailure(error) {
        // Handle scan failure, usually better to ignore and keep scanning
    }

    function startScanner() {
        if (scanner) {
            // Use environment camera (rear camera on mobile)
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0,
                formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE]
            };

            scanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .then(() => {
                    setStatus('Scanner is running. Select the session and scan a code.');
                })
                .catch((err) => {
                    setStatus(`Camera Blocked: ${err.message}. Please ensure the browser has camera permission.`, 'error');
                    console.error("Camera Start Error:", err);
                });
        }
    }

    function initializeScanner() {
        const readerId = "reader";
        
        // Polling loop to wait for Html5QrcodeScanner to load from CDN
        let pollStartTime = Date.now();
        const pollForScanner = setInterval(() => {
            if (typeof Html5QrcodeScanner !== 'undefined') {
                clearInterval(pollForScanner);
                setStatus('Scanner module loaded. Initializing camera...');
                scanner = new Html5QrcodeScanner(readerId, { fps: 10, qrbox: { width: 250, height: 250 } }, false);
                startScanner();
            } else if (Date.now() - pollStartTime > MAX_POLLING_TIME) {
                clearInterval(pollForScanner);
                setStatus('Library Load Timeout. Check CDN link in console.', 'error');
                console.error("FATAL ERROR: html5-qrcode library failed to load from CDN. Check the network tab for 404/network errors.");
            }
        }, POLLING_INTERVAL);
    }

    window.onload = initializeScanner;
</script>

</body>
</html>
